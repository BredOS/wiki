---
title: systemd-nspawn ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ç®¡ç†
description:
published: false
date: 2025-09-25T08:18:0446Z
tags:
editor: markdown
dateCreated: 2025-09-25T07:02:39.910Z
---

# ğŸ”„ 1. å…¥é–€æƒ…å ±

`systemd-nspawn` ã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚„OSç’°å¢ƒã‚’å³å¯†ã«éš”é›¢ã•ã‚ŒãŸç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚ŒãŸè»½é‡ã®ã‚³ãƒ³ãƒ†ãƒŠãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ å¤šãã®å ´åˆã€ã€Œã‚¹ãƒ†ãƒ­ã‚¤ãƒ‰ã®ã‚¯ãƒ­ãƒ¼ãƒˆã€ã¨ã—ã¦è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚ Linux ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã¾ãŸã¯æœ€å°é™ã®ç’°å¢ƒã‚’å®‰å…¨ã‹ã¤åˆ¶å¾¡ã•ã‚ŒãŸæ–¹æ³•ã§ãƒ†ã‚¹ãƒˆã¾ãŸã¯å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ä¾¿åˆ©ãªæ–¹æ³•ã‚’æä¾›ã—ã¾ã™ã€‚

QEMUã‚„Dockerã®ã‚ˆã†ãªã‚³ãƒ³ãƒ†ãƒŠãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã‚ˆã†ãªå®Œå…¨ãªä»®æƒ³åŒ–ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã¯ç•°ãªã‚Šã€`systemd-nspawn`ã¯Linuxåå‰ç©ºé–“ã¨cgroupsã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒã»ã¨ã‚“ã©ãªã„ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã¾ã™ã€‚

# 3. ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ

nspawn ã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ä¸Šã®ä»»æ„ã®å ´æ‰€ã‹ã‚‰å®Ÿè¡Œã§ãã¾ã™ãŒã€æ¨å¥¨ãƒ•ã‚©ãƒ«ãƒ€ã¯ `/var/lib/machines` ã§ã™ã€‚ ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã«ã€Linux/GNU rootfsã‚’ä¿æŒã™ã‚‹ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚ ãƒ—ãƒ­ã‚»ã‚¹ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã«ã€ã“ã®è¨˜äº‹ã§ã¯ã‚³ãƒ³ãƒ†ãƒŠãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚ ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã‚’æ–°ã—ã„å ´æ‰€ã«ã‚³ãƒ”ãƒ¼ã—ã€æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã¨ã—ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

- ãƒ«ãƒ¼ãƒˆã«åˆ‡ã‚Šæ›¿ãˆã‚‹:

```
sudo su
```

- æ¬¡ã«ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ `/var/lib/machines`ã«å¤‰æ›´ã—ã¾ã™ã€‚

```
cd /var/lib/mains
```

- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã™ã€‚

```
mkdir ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```

ã‚³ãƒ³ãƒ†ãƒŠã¯ã©ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒˆã‚’ã‚‚ã¤ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã‚ãªãŸã¯æ¯”è¼ƒçš„è‡ªç”±ã«é¸æŠã§ãã¾ã™ã€‚ Debianã€Ubuntuã€BredOSãªã©ã€æœ€å°é™ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®tarballã®ãƒªã‚¹ãƒˆã‚’æä¾›ã—ã¾ã™ã€‚ ãŸã ã—ã€ã“ã®è¨˜äº‹ã¯ç‰¹ã«ãƒ–ãƒ¬ãƒƒãƒ‰OSã‚³ãƒ³ãƒ†ãƒŠç”¨ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

> ã‚³ãƒ³ãƒ†ãƒŠãƒ¼å†…ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚³ãƒãƒ³ãƒ‰ã¯ã€BredOS ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã¯ã€ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒªã‚¢ãƒ³ãƒˆã«å¾“ã£ã¦èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
> {.is-warning}

- [Ubuntu-base](https://cdimage.ubuntu.com/ubuntu-base/releases/) é¸æŠè‚¢ã®ãƒªãƒªãƒ¼ã‚¹ã‚’èª¿ã¹ã¦ã€CPU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã® `.tar.gz` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- [Debian genericcloud](https://cloud.debian.org/images/cloud/) ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒªãƒªãƒ¼ã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€CPU ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã® `.tar.gz` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- [Fedora Container Base](https://fedoraproject.org/misc#minimal) ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã€ `Container Base` ã¾ãŸã¯ `Container Minimal Base` ã‚’é¸æŠã—ã¾ã™ã€‚
- [Arch Linux](https://archlinux.org/download/) è¿‘ãã®ãƒŸãƒ©ãƒ¼ã‚’é¸æŠã—ã€`.tar.zst` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
- [Arch Linux ARM](https://archlinuxarm.org/os/) `latest`ã¨`aarch64`ã¾ãŸã¯`armv7`ã‚¿ã‚°ã®.tar.gzãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
  {.links-list}

é¸æŠã—ãŸ rootfs ã‚¿ãƒ¼ãƒœãƒ¼ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‰ã€ãã‚Œã‚’æŠ½å‡ºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ã“ã®ä¾‹ã§ã¯ã€Arch Linux ARM tarball ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã€ã‚ã¨ã§ BredOS ã«å¤‰æ›ã—ã¾ã™ã€‚

- tarball ã‚’ `/var/lib/machines/template` ã«å±•é–‹ã—ã¾ã™ã€‚

```
sudo tar -xzf <your distro's tarball of choice> -C /var/lib/machines/template
```

- `template` ãƒ•ã‚©ãƒ«ãƒ€ã®å†…å®¹ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
ls template/
bin boot dev etc home lib mnt opt proc root run sbin srv syss tmp usr var
```

- ã‚³ãƒ³ãƒ†ãƒŠã‚’å…¥åŠ›ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
systemd-nspawn --machine="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" --directory=/var/lib/machines/template
```

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ `--machine` ã¯ã‚³ãƒ³ãƒ†ãƒŠã®åå‰ã‚’å®šç¾©ã—ã€`--directory` ã¯ã‚³ãƒ³ãƒ†ãƒŠã®å ´æ‰€ã‚’æŒ‡ã™ã€‚ ã‚³ãƒ³ãƒ†ãƒŠã‚’çµ‚äº†ã™ã‚‹ã«ã¯ã€ <kbd>Ctrl</kbd> + <kbd>D</kbd> ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ <kbd>Ctrl</kbd> + <kbd>]</kbd> ã‚’1ç§’ä»¥å†…ã«3å›ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠå†…ã§æœ€åˆã«ã—ãŸã„ã“ã¨ã¯ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–ã—ã¦ã‚·ã‚¹ãƒ†ãƒ ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ã§ã™ã€‚

- ã“ã‚Œã‚’è¡Œã†ã«ã¯ã€æ¬¡ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
pacman-key --init
pacman-key --populate
pacman -Syu
```

> ãƒ›ã‚¹ãƒˆåã®è§£æ±ºã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ãƒ›ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ `/var/lib/machines/template/etc/resolv.conf` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚
> {.is-danger}

- ãã®å¾Œã€ã‚«ãƒ¼ãƒãƒ«ã‚„ãƒ•ã‚¡ãƒ¼ãƒ ã‚¦ã‚§ã‚¢ã®ã‚ˆã†ãªunessecaryãªã‚‚ã®ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```
pacman -R linux-aarch64 linux-firmware
```

- ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’ BredOS ã«å¤‰æ›ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
pacman-key --recv-keys 77193F152BDBE6A6 BF0740F967BA439D DAEAD1E6D799C638 1BEF1BCEBA58EA33
pacman-key --lsign-key 77193F152BDBE6A6 BF0740F967BA439D DAEAD1E6D799C638 1BEF1BCEBA58EA33
echo -e '# --> BredOS Mirrorlist <-- #\n\n# BredOS Main mirror\nServer = https://repo.bredos.org/repo/$repo/$arch\n' | tee /etc/pacman.d/bredos-mirrorlist
```

- ãƒŸãƒ©ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã‚ˆã‚Š:

```
nano /etc/pacman.conf
```

- æœ€å¾Œã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
[BredOS-any]
Include = /etc/pacman.d/bredos-mirrorlist

[BredOS]
Include = /etc/pacman.d/bredos-mirrorlist
```

- æœ€å¾Œã«å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™:

```
pacman -Syu bred-os-release BredOS-any/lsb-release bredos-logo
```

- å¿…è¦ã«å¿œã˜ã¦ã€bredos-config ã‚„ bredos-news ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
pacman -Sy bredos-config bredos-news
```

# 4. ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ

ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠ [2. ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ](#h-3-create-container-template) ãƒ›ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚ ä¾‹ãˆã°ã€ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒã‚¤ã‚¹ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€[Open vSwitch](/en/how-to/open-vswitch)ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

- æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠã§ã“ã‚Œã‚’è¡Œã„ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```
mkdir /var/lib/machines/template-veth
rsync -avP /var/lib/machines/template/* /var/lib/machines/template-veth/
```

ã“ã®ã‚¬ã‚¤ãƒ‰ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã«ã€format@@0ã§ä½œæˆã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã„ç¶šã‘ã¾ã™ã€‚ ã‚³ãƒ³ãƒ†ãƒŠãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½œæˆ](#h-3-create-container-template ) ã€‚

- æœ€åˆã«ã€ä»¥å‰ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å…¥åŠ›ã—ã¾ã™:

```
systemd-nspawn --machine="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" --directory=/var/lib/machines/template
```

systemdã®ãƒ†ãƒ¼ãƒã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«ã€ `systemd-networkd` ã‚’ä½¿ç”¨ã—ã¦ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‡ãƒã‚¤ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚

- æ¬¡ã®2ã¤ã®æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™:

```
touch /etc/systemd/network/80-container-host0.network
nano /etc/systemd/network/99-wolVeth.network
```

- ä»¥ä¸‹ã‚’è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«è²¼ã‚Šä»˜ã‘ã¾ã™:

```
[Match]
Name=host0

[Network]
Address=<containers ip address> example -> 192.168.1.100/24
Gateway=<gateway of that network> example -> 192.168.1.1
DNS=<DNS Servers address> example -> 9.9.9.9
#DHCP=yes -> or comment Address, Gateway and DNS and uncomment DHCP to assign the address automatically
```

- æœ€å¾Œã«ã€`systemd-networkd`ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚

```
systemctl enable systemd-networkd
```

ã‚³ãƒ³ãƒ†ãƒŠãŒãã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹å§‹ã•ã›ã‚‹ã«ã¯ã€èµ·å‹•ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ (å‰ã®ã‚³ãƒãƒ³ãƒ‰ã¯ chrootã®ã‚ˆã†ãªã‚‚ã®ã§ã™)ã€‚ ã“ã‚Œã¯ `--boot` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦è¡Œã„ã¾ã™ã€‚

```
systemd-nspawn --machine="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ" --directory=/var/lib/machines/template --boot
```

ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ç§»å‹•ã—ã¾ã™ã€‚ ã“ã“ã§ã¯ root ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã®ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹å‰ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã‹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³[4. ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹](#h-4-run-container-as-a-service)ã€‚

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
useradd <your username here>
passwd <your username here>
```

# ğŸš€ 4. ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè¡Œ
